<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Swing Trade Manager</title>
<link rel="stylesheet" href="styles-new.css">
<link rel="stylesheet" href="styles-compat.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="app-container">
<!-- HEADER -->
<header class="app-header">
  <h1 class="app-title">ï¿½ Swing Trade Manager</h1>
  <p class="app-subtitle">Controle completo dos seus investimentos</p>
</header>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-section">
    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="loadExcel()" style="display:none;">
    <button class="btn btn-secondary" onclick="document.getElementById('excelFile').click()">ğŸ“¥ Importar Excel</button>
    <button class="btn btn-primary" onclick="abrirModalCadastroLote()">â•â• Cadastro em Lote</button>
    <button class="btn btn-success" onclick="abrirModalTransacao()">â• Nova TransaÃ§Ã£o</button>
  </div>
  <div class="toolbar-section">
    <button class="btn btn-secondary" onclick="updateRealTimePrices()" id="updatePricesBtn" disabled>ğŸ”„ Atualizar PreÃ§os</button>
    <button class="btn btn-secondary" onclick="exportReport()" id="exportBtn" disabled>ğŸ“¤ Exportar JSON</button>
    <button class="btn btn-secondary" onclick="exportExcel()" id="exportExcelBtn" disabled>ğŸ“¥ Exportar XLSX</button>
    <button class="btn btn-secondary" onclick="fazerBackupBanco()" title="Download do banco SQLite">ğŸ’¾ Backup BD</button>
  </div>
  <!-- Campo Caixa Renda Fixa removido - agora integrado com ativos -->
</div>

<!-- STATUS MESSAGE -->
<div id="statusMessage" class="status-message hidden"></div>

<!-- SUMMARY CARDS -->
<div id="summaryCards" class="summary-grid"></div>

<!-- TABS -->
<div class="tabs" id="tabs" style="display:none;">
  <button class="tab-btn active" onclick="switchTab('resumo')">ğŸ“Š Resumo</button>
  <button class="tab-btn" onclick="switchTab('ativos')">ğŸ“ˆ Ativos Atuais</button>
  <button class="tab-btn" onclick="switchTab('todos')">ğŸ“‹ Todos os Ativos</button>
  <button class="tab-btn" onclick="switchTab('trades')">ğŸ’¹ Trades Realizados</button>
  <button class="tab-btn" onclick="switchTab('proventos')">ğŸ’° Proventos</button>
  <button class="tab-btn" onclick="switchTab('rendafixa')">ğŸ¦ Renda Fixa</button>
  <button class="tab-btn" onclick="switchTab('historico')">ğŸ” HistÃ³rico Completo</button>
</div>

<!-- ABA RESUMO -->
<div id="resumo" class="tab-content active">
  <div id="categoryChartContainer" style="display:none;margin-bottom:30px;background:#161b22;padding:20px;border-radius:10px;">
    <h2>ComposiÃ§Ã£o da Carteira (Valor Atual)</h2>
    <div style="position:relative;height:400px;">
      <canvas id="categoryChart"></canvas>
    </div>
  </div>

  <div id="categorySummaryContainer" style="display:none;">
    <h2>Resumo por Categoria</h2>
    <div class="table-container">
      <table>
        <thead><tr>
          <th>Categoria</th>
          <th class="num-col">Qtd Ativos</th>
          <th class="num-col">Valor Investido</th>
          <th class="num-col">Valor Atual</th>
          <th class="num-col">Lucro Realizado</th>
          <th class="num-col">Lucro Aberto</th>
          <th class="num-col">Lucro Total</th>
          <th class="num-col">Rentabilidade</th>
        </tr></thead>
        <tbody id="categorySummaryBody"></tbody>
      </table>
    </div>
  </div>

  <div class="charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
    <div id="profitChartContainer" style="display:none;background:#161b22;padding:20px;border-radius:10px;">
      <h2>Lucro Realizado vs Aberto</h2>
      <div style="position:relative;height:300px;">
        <canvas id="profitChart"></canvas>
      </div>
    </div>
    <div id="patrimonioChartContainer" style="display:none;background:#161b22;padding:20px;border-radius:10px;">
      <h2>ComposiÃ§Ã£o do PatrimÃ´nio</h2>
      <div style="position:relative;height:300px;">
        <canvas id="patrimonioChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ABA ATIVOS ATUAIS -->
<div id="ativos" class="tab-content">
  <div class="filtro-container">
    <div class="filter-group">
      <label><strong>Categorias:</strong></label>
      <div id="filterCategoryAtivosContainer" class="checkbox-group"></div>
    </div>
    <label>Ativo:
      <input type="text" id="filterSymbolAtivos" placeholder="Ex: SBUB11" onkeyup="filterCurrentAssets()">
    </label>
    <button onclick="clearFiltersAtivos()">Limpar Filtros</button>
  </div>
  <div class="table-container">
    <table>
      <thead><tr>
        <th>Ativo</th><th>Categoria</th><th class="num-col">Qtd Atual</th><th class="num-col">Qtd Comprada</th><th class="num-col">Qtd Vendida</th>
        <th class="num-col">PreÃ§o MÃ©dio</th><th class="num-col">PreÃ§o Atual</th><th class="num-col">Custo PosiÃ§Ã£o</th><th class="num-col">Valor Atual</th>
        <th class="num-col">Lucro Realizado</th><th class="num-col">Lucro Aberto</th><th class="num-col">Lucro Total</th><th class="num-col">Rentabilidade</th>
      </tr></thead>
      <tbody id="assetsBody"></tbody>
    </table>
  </div>
  <div id="paginationAtivos"></div>

  <div class="details-section" id="detailsSection" style="display:none;">
    <h2>ğŸ“ˆ Detalhes por Ativo</h2>
    <div id="assetDetails"></div>
  </div>
</div>

<!-- ABA TODOS OS ATIVOS -->
<div id="todos" class="tab-content">
  <div class="filtro-container">
    <div class="filter-group">
      <label><strong>Categorias:</strong></label>
      <div id="filterCategoryContainer" class="checkbox-group"></div>
    </div>
    <label>Ativo:
      <input type="text" id="filterSymbol" placeholder="Ex: SBUB11" onkeyup="filterAllAssets()">
    </label>
    <button onclick="clearFiltersTodos()">Limpar Filtros</button>
  </div>
  <div class="table-container">
    <table>
      <thead><tr>
        <th>Ativo</th><th>Categoria</th><th class="num-col">Qtd Atual</th><th class="num-col">Qtd Comprada</th><th class="num-col">Qtd Vendida</th>
        <th class="num-col">PreÃ§o MÃ©dio Compra</th><th class="num-col">PreÃ§o MÃ©dio Venda</th><th class="num-col">Total Investido</th><th class="num-col">Total Recuperado</th>
        <th class="num-col">Lucro Realizado</th><th class="num-col">Lucro Aberto</th><th class="num-col">Valor Atual</th><th class="num-col">Lucro Total</th><th class="num-col">Rentabilidade Total</th>
      </tr></thead>
      <tbody id="allAssetsBody"></tbody>
    </table>
  </div>
  <div id="paginationTodos"></div>
</div>

<!-- ABA TRADES REALIZADOS -->
<div id="trades" class="tab-content">
  <div class="filtro-container">
    <label>Filtrar por ativo: <input type="text" id="filterAsset" placeholder="Ex: SBUB11" onkeyup="filterTrades()"></label>
    <button onclick="document.getElementById('filterAsset').value=''; filterTrades();">Limpar Filtro</button>
  </div>
  <div id="tradesContainer"></div>
  <div id="paginationTrades"></div>
</div>

<!-- ABA PROVENTOS -->
<div id="proventos" class="tab-content">
  <div class="filtro-container" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:16px;background:#0d1117;border:1px solid #30363d;border-radius:8px;margin-bottom:20px;">
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <button class="btn btn-success" onclick="abrirModalProvento()" style="display:flex;align-items:center;gap:6px;">â• Adicionar Provento</button>
      
      <div style="display:flex;align-items:center;gap:8px;">
        <label style="display:flex;align-items:center;gap:6px;color:#a0a9c8;font-weight:500;">
          Ativo:
          <input type="text" class="form-input" id="filterProventoAtivo" placeholder="Ex: PETR4" onkeyup="filterProventos()" style="width:120px;padding:6px 10px;height:32px;">
        </label>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <label style="display:flex;align-items:center;gap:6px;color:#a0a9c8;font-weight:500;">
          Tipo:
          <select class="form-select" id="filterProventoTipo" onchange="filterProventos()" style="width:140px;padding:6px 10px;height:32px;">
            <option value="">Todos</option>
            <option value="Dividendo">Dividendo</option>
            <option value="JCP">JCP</option>
            <option value="Rendimento">Rendimento</option>
          </select>
        </label>
      </div>

      <div style="display:flex;align-items:center;gap:6px;">
        <label style="color:#a0a9c8;font-weight:500;">PerÃ­odo:</label>
        <input type="date" class="form-input" id="filterProventoInicio" onchange="filterProventos()" style="width:120px;padding:6px 10px;height:32px;">
        <span style="color:#a0a9c8;">atÃ©</span>
        <input type="date" class="form-input" id="filterProventoFim" onchange="filterProventos()" style="width:120px;padding:6px 10px;height:32px;">
      </div>
    </div>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-secondary" onclick="limparFiltrosProventos()" style="padding:6px 12px;font-size:0.9rem;">ğŸ”„ Limpar</button>
      <button class="btn btn-secondary" onclick="importarProventosExcel()" style="padding:6px 12px;font-size:0.9rem;">ğŸ“¥ Importar</button>
    </div>
  </div>

  <div id="proventosSummaryCards" class="summary-cards"></div>

  <div id="proventosChartContainer" style="display:none;margin-bottom:20px;background:#161b22;padding:20px;border-radius:10px;">
    <h2>Proventos ao Longo do Tempo</h2>
    <div style="position:relative;height:300px;">
      <canvas id="proventosChart"></canvas>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Data Pagamento</th>
          <th>Data COM</th>
          <th>Ativo</th>
          <th>Tipo</th>
          <th class="num-col">Valor Unit.</th>
          <th class="num-col">Quantidade</th>
          <th class="num-col">Total</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="proventosBody"></tbody>
    </table>
  </div>
  <div id="paginationProventos"></div>
</div>

<!-- ABA RENDA FIXA -->
<div id="rendafixa" class="tab-content">
  <div class="filtro-container" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:15px;background:#0d1117;border-radius:8px;margin-bottom:20px;">
    <div style="display:flex;gap:10px;">
      <button onclick="abrirModalRendaFixa()" class="btn btn-success" style="display:flex;align-items:center;gap:8px;">
        <span>â•</span> Adicionar Investimento
      </button>
      <button onclick="abrirModalTaxas()" class="btn btn-secondary" style="display:flex;align-items:center;gap:8px;background:#0969da;">
        <span>âš™ï¸</span> Configurar Taxas
      </button>
    </div>

    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <label style="display:flex;align-items:center;gap:8px;margin:0;">
        <strong style="color:#8b949e;font-size:13px;">Tipo:</strong>
        <select id="filterRendaFixaTipo" onchange="filterRendaFixa()" style="min-width:150px;">
          <option value="">Todos os tipos</option>
          <option value="CDB">ğŸ¦ CDB</option>
          <option value="LCI">ğŸ  LCI</option>
          <option value="LCA">ğŸŒ¾ LCA</option>
          <option value="Tesouro Selic">ğŸ“Š Tesouro Selic</option>
          <option value="Tesouro IPCA+">ğŸ“ˆ Tesouro IPCA+</option>
          <option value="Tesouro Prefixado">ğŸ“‰ Tesouro Prefixado</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;gap:8px;margin:0;">
        <strong style="color:#8b949e;font-size:13px;">Status:</strong>
        <select id="filterRendaFixaStatus" onchange="filterRendaFixa()" style="min-width:120px;">
          <option value="ativos">âœ… Ativos</option>
          <option value="resgatados">ğŸ’¸ Resgatados</option>
          <option value="todos">ğŸ“‹ Todos</option>
        </select>
      </label>

      <button onclick="limparFiltrosRendaFixa()" class="btn" style="background:#21262d;color:#8b949e;border:1px solid #30363d;padding:8px 16px;">
        ğŸ—‘ï¸ Limpar
      </button>
    </div>
  </div>

  <div id="rendaFixaSummaryCards" class="summary-cards"></div>

  <div class="charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
    <div id="rendaFixaChartContainer" style="display:none;background:#161b22;padding:20px;border-radius:10px;">
      <h2>ComposiÃ§Ã£o por Tipo</h2>
      <div style="position:relative;height:300px;">
        <canvas id="rendaFixaChart"></canvas>
      </div>
    </div>
    <div id="rendaFixaProjecaoContainer" style="display:none;background:#161b22;padding:20px;border-radius:10px;">
      <h2>ProjeÃ§Ã£o 12 Meses</h2>
      <div style="position:relative;height:300px;">
        <canvas id="rendaFixaProjecaoChart"></canvas>
      </div>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Tipo</th>
          <th>InstituiÃ§Ã£o</th>
          <th class="num-col">Investido</th>
          <th class="num-col">Rentabilidade</th>
          <th class="num-col">Rendimento</th>
          <th class="num-col">Valor Atual</th>
          <th class="num-col">Dias</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="rendaFixaBody"></tbody>
    </table>
  </div>
  <div id="paginationRendaFixa"></div>
</div>

<!-- ABA HISTÃ“RICO COMPLETO -->
<div id="historico" class="tab-content">
  <!-- Barra de busca e filtros -->
  <div class="filter-bar" style="margin-bottom: 20px;">
    <div class="filter-group">
      <label for="searchHistorico">ğŸ” Buscar:</label>
      <input type="text" id="searchHistorico" placeholder="Digite o ativo, tipo ou categoria..." onkeyup="filterHistorico()">
    </div>
    <div class="filter-group">
      <label for="filterHistoricoTipo">Tipo:</label>
      <select id="filterHistoricoTipo" onchange="filterHistorico()">
        <option value="">Todos</option>
        <option value="C">Compra</option>
        <option value="V">Venda</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filterHistoricoCategoria">Categoria:</label>
      <select id="filterHistoricoCategoria" onchange="filterHistorico()">
        <option value="">Todas</option>
        <option value="AÃ§Ãµes">AÃ§Ãµes</option>
        <option value="Fundos ImobiliÃ¡rios">Fundos ImobiliÃ¡rios</option>
        <option value="BDR">BDR</option>
        <option value="ETF">ETF</option>
        <option value="Cripto">Criptomoedas</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table id="transactionsTable">
      <thead><tr>
        <th>#</th><th>Data</th><th>Ativo</th><th>Tipo</th><th class="num-col">Qtd</th><th class="num-col">PreÃ§o Unit.</th>
        <th class="num-col">Custos</th><th class="num-col">Total TransaÃ§Ã£o</th><th>Categoria</th><th class="num-col">Qtd em Carteira</th>
        <th class="num-col">Lucro Realizado Acum.</th><th class="num-col">Caixa Acumulado</th><th>AÃ§Ãµes</th>
      </tr></thead>
      <tbody id="transactionsBody"></tbody>
    </table>
  </div>
  <div id="paginationHistorico"></div>
</div>

</div>

<!-- MODAL PROVENTO -->
<div id="modalProvento" class="modal">
  <div class="modal-content" style="max-width:650px;">
    <div class="modal-header">
      <h2 id="modalProventoTitulo" class="modal-title">ğŸ’° Adicionar Provento</h2>
      <button type="button" class="btn-icon" onclick="fecharModalProvento()" title="Fechar">âœ•</button>
    </div>

    <form id="formProvento" onsubmit="salvarProvento(event)">
      <input type="hidden" id="proventoId">

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Ativo *</label>
          <input type="text" class="form-input input-uppercase" id="proventoAtivo" required placeholder="Ex: PETR4" title="CÃ³digo do ativo">
        </div>

        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select class="form-select" id="proventoTipo" required title="Tipo de provento">
            <option value="">Selecione...</option>
            <option value="Dividendo">ğŸ’µ Dividendo</option>
            <option value="JCP">ğŸ“Š JCP (Juros sobre Capital PrÃ³prio)</option>
            <option value="Rendimento">ğŸ’° Rendimento</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Valor UnitÃ¡rio (R$) *</label>
          <input type="number" class="form-input" id="proventoValor" step="0.0001" required placeholder="0.00" title="Valor por aÃ§Ã£o" oninput="calcularTotalProvento()">
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade de AÃ§Ãµes *</label>
          <input type="number" class="form-input" id="proventoQtd" step="1" required placeholder="100" title="Quantas aÃ§Ãµes vocÃª tinha" oninput="calcularTotalProvento()">
        </div>

        <div class="form-group">
          <label class="form-label">Data COM *</label>
          <input type="date" class="form-input" id="proventoDataCom" required title="Data em que tinha as aÃ§Ãµes">
          <small class="form-help">Data em que tinha as aÃ§Ãµes</small>
        </div>

        <div class="form-group">
          <label class="form-label">Data de Pagamento *</label>
          <input type="date" class="form-input" id="proventoDataPgto" required title="Data do recebimento">
          <small class="form-help">Data que recebeu o valor</small>
        </div>
      </div>

      <div id="proventoTotal" class="form-total-box">
        <div class="form-total-label">Total a Receber</div>
        <div class="form-total-value">R$ 0,00</div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalProvento()">Cancelar</button>
        <button type="submit" class="btn btn-success">ğŸ’¾ Salvar Provento</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL RENDA FIXA -->
<div id="modalRendaFixa" class="modal">
  <div class="modal-content" style="max-width:800px;">
    <div class="modal-header">
      <h2 id="modalRendaFixaTitulo" class="modal-title">ğŸ¦ Adicionar Investimento Renda Fixa</h2>
      <button type="button" class="btn-icon" onclick="fecharModalRendaFixa()" title="Fechar">âœ•</button>
    </div>

    <form id="formRendaFixa" onsubmit="salvarRendaFixa(event)">
      <input type="hidden" id="rendaFixaId">

      <!-- Grid de 2 colunas -->
      <div class="form-grid">
        <div class="form-group form-grid-full-width">
          <label class="form-label">Nome do Investimento *</label>
          <input type="text" class="form-input" id="rendaFixaNome" placeholder="Ex: CDB Banco Inter 110% CDI" title="Nome descritivo do investimento" required>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select class="form-select" id="rendaFixaTipo" title="Tipo de investimento" required onchange="atualizarCamposRendaFixa()">
            <option value="">Selecione...</option>
            <option value="CDB">ğŸ¦ CDB</option>
            <option value="LCI">ğŸ  LCI (Isento de IR)</option>
            <option value="LCA">ğŸŒ¾ LCA (Isento de IR)</option>
            <option value="Tesouro Selic">ğŸ“Š Tesouro Selic</option>
            <option value="Tesouro IPCA+">ğŸ“ˆ Tesouro IPCA+</option>
            <option value="Tesouro Prefixado">ğŸ“‰ Tesouro Prefixado</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">InstituiÃ§Ã£o Financeira</label>
          <input type="text" class="form-input" id="rendaFixaInstituicao" placeholder="Ex: Banco Inter" title="Qual banco ou instituiÃ§Ã£o">
        </div>

        <div class="form-group">
          <label class="form-label">Valor Investido (R$) *</label>
          <input type="number" class="form-input" id="rendaFixaValor" step="0.01" required placeholder="10000.00" title="Valor inicial investido" oninput="atualizarPreviewRendaFixa()">
        </div>

        <div class="form-group">
          <label class="form-label" id="rendaFixaTaxaLabel">Taxa (% do CDI) *</label>
          <input type="number" class="form-input" id="rendaFixaTaxa" step="0.01" required placeholder="110" title="Taxa de rendimento" oninput="atualizarPreviewRendaFixa()">
          <small id="rendaFixaTaxaHelp" class="form-help">Para CDB/LCI/LCA: % do CDI (ex: 110)</small>
        </div>

        <div class="form-group">
          <label class="form-label">Data de InÃ­cio *</label>
          <input type="date" class="form-input" id="rendaFixaDataInicio" required title="Quando comeÃ§ou o investimento" oninput="atualizarPreviewRendaFixa()">
        </div>

        <div class="form-group" id="divDataVencimento">
          <label class="form-label">Data de Vencimento</label>
          <input type="date" class="form-input" id="rendaFixaDataVenc" title="Data do vencimento" oninput="atualizarPreviewRendaFixa()">
          <small class="form-help">Deixe em branco se nÃ£o houver</small>
        </div>

        <div class="form-group">
          <label class="form-label">Liquidez</label>
          <select class="form-select" id="rendaFixaLiquidez" title="Tipo de liquidez" onchange="atualizarLiquidezRendaFixa()">
            <option value="DiÃ¡ria">ğŸ’§ Liquidez DiÃ¡ria</option>
            <option value="Vencimento">ğŸ”’ Apenas no Vencimento</option>
          </select>
        </div>

        <div class="form-group form-grid-full-width">
          <label class="form-label">ObservaÃ§Ãµes</label>
          <textarea class="form-input form-textarea" id="rendaFixaObs" rows="3" placeholder="InformaÃ§Ãµes adicionais..." title="Notas adicionais"></textarea>
        </div>
      </div>

      <div id="rendaFixaPreview" class="form-preview">
        <h4 class="form-preview-title">ğŸ“Š ProjeÃ§Ã£o Atual</h4>
        <div id="rendaFixaPreviewContent" class="form-preview-grid"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalRendaFixa()">Cancelar</button>
        <button type="submit" class="btn btn-success">ğŸ’¾ Salvar Investimento</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL CONFIGURAR TAXAS -->
<div id="modalTaxas" class="modal">
  <div class="modal-content" style="max-width:600px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h2 style="margin:0;">âš™ï¸ Configurar Taxas de ReferÃªncia</h2>
      <button type="button" onclick="fecharModalTaxas()" style="background:transparent;border:none;color:#8b949e;font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;">&times;</button>
    </div>

    <form id="formTaxas" onsubmit="salvarTaxas(event)">
      <div style="background:#0d1117;border:1px solid #30363d;padding:15px;border-radius:6px;margin-bottom:20px;">
        <p style="color:#8b949e;margin:0;font-size:14px;">
          ğŸ“Š Atualize as taxas de referÃªncia para cÃ¡lculos mais precisos de rentabilidade.
        </p>
      </div>

      <div style="display:grid;gap:15px;">
        <label>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
            <strong>CDI (% ao ano)</strong> <span style="color:#da3633;">*</span>
          </div>
          <input type="number" id="taxaCDI" step="0.01" required placeholder="11.65" style="width:100%;">
          <small style="color:#8b949e;display:block;margin-top:5px;font-size:12px;">
            ğŸ’° Certificado de DepÃ³sito InterbancÃ¡rio - referÃªncia para CDB, LCI e LCA
          </small>
        </label>

        <label>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
            <strong>Selic (% ao ano)</strong> <span style="color:#da3633;">*</span>
          </div>
          <input type="number" id="taxaSelic" step="0.01" required placeholder="11.75" style="width:100%;">
          <small style="color:#8b949e;display:block;margin-top:5px;font-size:12px;">
            ğŸ“ˆ Taxa bÃ¡sica de juros - referÃªncia para Tesouro Selic
          </small>
        </label>

        <label>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
            <strong>IPCA (% ao ano)</strong> <span style="color:#da3633;">*</span>
          </div>
          <input type="number" id="taxaIPCA" step="0.01" required placeholder="4.62" style="width:100%;">
          <small style="color:#8b949e;display:block;margin-top:5px;font-size:12px;">
            ğŸ“Š Ãndice de inflaÃ§Ã£o (Ãºltimos 12 meses) - referÃªncia para Tesouro IPCA+
          </small>
        </label>
      </div>

      <div style="background:#0d1117;border-left:3px solid #58a6ff;padding:12px 15px;border-radius:4px;margin:20px 0;">
        <small style="color:#8b949e;font-size:13px;">
          ğŸ’¡ <strong style="color:#e6edf3;">Dica:</strong> Consulte as taxas atualizadas em:
          <a href="https://www.bcb.gov.br" target="_blank" style="color:#58a6ff;text-decoration:none;">Banco Central do Brasil</a>
        </small>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:15px;border-top:1px solid #30363d;">
        <button type="button" onclick="fecharModalTaxas()" style="background:#21262d;color:#8b949e;border:1px solid #30363d;padding:10px 24px;">Cancelar</button>
        <button type="submit" style="background:#0969da;padding:10px 24px;">ğŸ’¾ Salvar Taxas</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL NOVA TRANSAÃ‡ÃƒO -->
<div id="modalTransacao" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTransacaoTitulo" class="modal-title">â• Nova TransaÃ§Ã£o</h2>
      <button type="button" class="btn-icon" onclick="fecharModalTransacao()" title="Fechar">âœ•</button>
    </div>

    <form id="formTransacao" onsubmit="salvarTransacao(event)">
      <input type="hidden" id="transacaoId">

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Data da OperaÃ§Ã£o *</label>
          <input type="date" class="form-input" id="transacaoData" required title="Data da operaÃ§Ã£o">
        </div>

        <div class="form-group">
          <label class="form-label">Tipo de OperaÃ§Ã£o *</label>
          <select class="form-select" id="transacaoTipo" required title="Compra ou Venda">
            <option value="">Selecione...</option>
            <option value="C">Compra</option>
            <option value="V">Venda</option>
          </select>
        </div>

        <div class="form-group form-grid-full-width">
          <label class="form-label">CÃ³digo do Ativo *</label>
          <input type="text" class="form-input input-uppercase" id="transacaoAtivo" required placeholder="Ex: PETR4, BBDC4" title="CÃ³digo do ativo">
          <small class="form-help">Digite o cÃ³digo do ativo (ex: PETR4 para Petrobras)</small>
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade *</label>
          <input type="number" class="form-input" id="transacaoQtd" step="0.01" required placeholder="100" title="Quantas unidades">
        </div>

        <div class="form-group">
          <label class="form-label">PreÃ§o UnitÃ¡rio (R$) *</label>
          <input type="number" class="form-input" id="transacaoPreco" step="0.01" required placeholder="38.50" title="PreÃ§o por unidade">
        </div>

        <div class="form-group">
          <label class="form-label">Custos/Taxas (R$)</label>
          <input type="number" class="form-input" id="transacaoCustos" step="0.01" placeholder="10.00" value="0" title="Corretagem e taxas">
          <small class="form-help">Corretagem, emolumentos, etc.</small>
        </div>

        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select class="form-select" id="transacaoCategoria" title="Tipo de ativo">
            <option value="">Selecione...</option>
            <option value="AÃ§Ãµes">AÃ§Ãµes</option>
            <option value="Fundos ImobiliÃ¡rios">Fundos ImobiliÃ¡rios</option>
            <option value="ETFs">ETFs</option>
            <option value="BDRs">BDRs</option>
            <option value="Stocks">Stocks (AÃ§Ãµes Internacionais)</option>
            <option value="REITs">REITs</option>
            <option value="Cripto">Criptomoedas</option>
            <option value="Outros">Outros</option>
          </select>
        </div>

        <div class="form-group form-grid-full-width">
          <label class="form-label">ObservaÃ§Ãµes</label>
          <textarea class="form-input form-textarea" id="transacaoObs" rows="2" placeholder="InformaÃ§Ãµes adicionais..." title="Notas sobre a transaÃ§Ã£o"></textarea>
        </div>
      </div>

      <div id="transacaoPreview" style="padding:12px;background:#21262d;border-radius:6px;margin:16px 0;border-left:3px solid #58a6ff;">
        <strong style="color:#58a6ff;">ğŸ’¡ Resumo da OperaÃ§Ã£o:</strong>
        <div id="transacaoPreviewContent" style="color:#8b949e;margin-top:8px;font-size:0.9em;">
          Preencha os campos para ver o resumo
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalTransacao()">Cancelar</button>
        <button type="submit" class="btn btn-success">ğŸ’¾ Salvar TransaÃ§Ã£o</button>
      </div>
    </form>
  </div>
</div>

<!-- Input file oculto para importaÃ§Ã£o -->
<input type="file" id="proventosFileInput" accept=".xlsx,.xls" style="display:none;">

<!-- MODAL CADASTRO EM LOTE -->
<div id="modalCadastroLote" class="modal">
  <div class="modal-content" style="max-width:1200px;">
    <div class="modal-header">
      <h2 class="modal-title">â•â• Cadastro em Lote de TransaÃ§Ãµes</h2>
      <button type="button" class="btn-icon" onclick="fecharModalCadastroLote()" title="Fechar">âœ•</button>
    </div>

    <div style="background:#21262d;padding:15px;border-radius:6px;margin-bottom:20px;border-left:4px solid #58a6ff;">
      <strong>ğŸ’¡ Dica:</strong> Preencha vÃ¡rias transaÃ§Ãµes de uma vez. Use TAB para navegar entre os campos.
    </div>

    <div style="overflow-x:auto;margin-bottom:20px;">
      <table style="width:100%;border-collapse:collapse;background:#161b22;">
        <thead>
          <tr style="background:#21262d;">
            <th style="padding:12px;border:1px solid #30363d;min-width:120px;">Data</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:100px;">Ativo</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:80px;">Tipo</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:100px;">Quantidade</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:100px;">PreÃ§o (R$)</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:100px;">Custos (R$)</th>
            <th style="padding:12px;border:1px solid #30363d;min-width:120px;">Categoria</th>
            <th style="padding:12px;border:1px solid #30363d;width:60px;">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="tabelaCadastroLote">
          <!-- Linhas serÃ£o inseridas aqui via JS -->
        </tbody>
      </table>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:20px;">
      <button class="btn btn-success" onclick="adicionarLinhaLote()">â• Adicionar Linha</button>
      <button class="btn btn-secondary" onclick="limparTabelaLote()">ğŸ—‘ï¸ Limpar Tudo</button>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="fecharModalCadastroLote()">Cancelar</button>
      <button type="button" class="btn btn-success" onclick="salvarTransacoesLote()">ğŸ’¾ Salvar Todas</button>
    </div>
  </div>
</div>

<!-- Modal de ConfirmaÃ§Ã£o Customizado -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-dialog">
    <div class="confirm-header">
      <span class="confirm-icon" id="confirmIcon">âš ï¸</span>
      <h3 class="confirm-title" id="confirmTitle">Confirmar aÃ§Ã£o</h3>
    </div>
    <div class="confirm-body">
      <p class="confirm-message" id="confirmMessage"></p>
    </div>
    <div class="confirm-footer">
      <button class="confirm-btn confirm-btn-cancel" id="confirmCancel">Cancelar</button>
      <button class="confirm-btn confirm-btn-confirm" id="confirmOk">Confirmar</button>
    </div>
  </div>
</div>

<script>
// VerificaÃ§Ã£o de autenticaÃ§Ã£o - OBRIGATÃ“RIA
(function() {
  const isAuthenticated = localStorage.getItem('isAuthenticated');
  const authToken = localStorage.getItem('authToken');
  
  // SEMPRE requer login com token vÃ¡lido
  if (!isAuthenticated || !authToken) {
    localStorage.clear();
    window.location.href = 'login.html';
    return;
  }

  // Verifica se o token ainda Ã© vÃ¡lido
  const API_URL = 'http://localhost:3000/api';
  fetch(API_URL + '/auth/verify', {
    headers: {
      'Authorization': 'Bearer ' + authToken
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.valid) {
      // Token invÃ¡lido, faz logout
      localStorage.clear();
      alert('SessÃ£o expirada. FaÃ§a login novamente.');
      window.location.href = 'login.html';
    }
  })
  .catch(err => {
    console.error('Erro ao verificar token:', err);
    localStorage.clear();
    alert('Erro ao verificar autenticaÃ§Ã£o. FaÃ§a login novamente.');
    window.location.href = 'login.html';
  });

  // Adiciona botÃ£o de logout e informaÃ§Ãµes do usuÃ¡rio
  const currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    const toolbar = document.querySelector('.toolbar .toolbar-section:last-child');
    if (toolbar) {
      // Mostra nome do usuÃ¡rio
      const userInfo = document.createElement('span');
      userInfo.style.marginRight = '10px';
      userInfo.style.color = 'var(--text-secondary)';
      userInfo.textContent = 'ğŸ‘¤ ' + currentUser;
      toolbar.appendChild(userInfo);

      // BotÃ£o de logout
      const logoutBtn = document.createElement('button');
      logoutBtn.className = 'btn btn-danger';
      logoutBtn.textContent = 'ğŸšª Sair';
      logoutBtn.onclick = function() {
        if (confirm('Deseja realmente sair?')) {
          localStorage.clear();
          window.location.href = 'login.html';
        }
      };
      toolbar.appendChild(logoutBtn);
    }
  }
})();
</script>

<script type="module" src="js/main.js"></script>
<script src="js/cadastro-lote.js"></script>
</body>
</html>

